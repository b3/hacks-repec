#!/bin/bash
# Récupère l'intégralité des archives de RePEc en local.
# 
# usage: get-archives [OPTIONS] [DEST]
#
# Les archives sont copiées dans DEST/remo en loguant les téléchargements dans
# DEST/log/get-archives.log. Les archives récupérées sont celles aux codes de
# 3 lettres, définies dans DEST/remo/all.
#
# Par défaut DEST=/home/repec/RePEc.
# 
# OPTIONS possibles :
#     -h, --help  affiche ce message

usage () { sed -n '2,/^$/ {s/^ *#// ; s/^ //g ; p }' <$0 ; }
[ "x$1" = "x-h" -o "x$1" = "x--help" ] && usage && exit

set -e
umask 0002

DEST="${1:-/home/repec/RePEc}"

cd "$DEST/remo"
mkdir -p ../log 
(
    exec 2>&1

    (                           # Liste des archives à copier
        cd all
        grep -a '^URL:' ???arch.rdf | \
        sed -r \
            -e 's!(...)arch.rdf:URL: *(.*)$!\1 \2!' \
            -e 's!\r$!!' \
            -e 's! *$!!' \
            -e 's!/$!!'
    ) |
    {                           # Récupération des archives
        while read arc url
        do
            (
                echo "$arc $url"
                ndirs=$(sed -e 's!^[^:]*://[^/]*!!' -e 's![^/]!!g' <<< $url)
                ndirs=${#ndirs}
                mkdir -p $arc
                cd $arc
                wget -np -A "*.rdf" -nv -m -nH --cut-dirs=$ndirs "$url"
            )
        done
    }
) | tee -a $DEST/log/$(basename $0).log
